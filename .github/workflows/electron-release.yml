name: Build and Release Electron App

on:
    push:
        tags:
            - "v*.*.*"
    workflow_dispatch:

jobs:
    build:
        name: Build ${{ matrix.os }} - ${{ matrix.arch }}
        runs-on: ${{ matrix.runner }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    # Windows builds
                    - os: windows
                      runner: windows-latest
                      arch: x64
                      target: nsis,portable
                      artifact: windows-x64

                    # macOS builds
                    - os: macos
                      runner: macos-latest
                      arch: x64
                      target: dmg,zip
                      artifact: macos-x64

                    - os: macos
                      runner: macos-latest
                      arch: arm64
                      target: dmg,zip
                      artifact: macos-arm64

                    # Linux builds
                    - os: linux
                      runner: ubuntu-latest
                      arch: x64
                      target: AppImage,deb,rpm
                      artifact: linux-x64

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: frontend/package-lock.json

            - name: Install dependencies
              working-directory: frontend
              run: npm ci

            - name: Read version
              id: version
              shell: bash
              run: |
                  VERSION=$(jq -r '.version' config.json)
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Building version: $VERSION"

            - name: Update package.json version
              working-directory: frontend
              shell: bash
              run: |
                  npm version ${{ steps.version.outputs.version }} --no-git-tag-version

            - name: Install Linux dependencies
              if: matrix.os == 'linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y rpm

            - name: Build Electron app (Windows)
              if: matrix.os == 'windows'
              working-directory: frontend
              run: npm run electron:build:win
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Build Electron app (macOS)
              if: matrix.os == 'macos'
              working-directory: frontend
              run: |
                  if [ "${{ matrix.arch }}" = "arm64" ]; then
                    npm run electron:build:mac -- --arm64
                  else
                    npm run electron:build:mac -- --x64
                  fi
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Build Electron app (Linux)
              if: matrix.os == 'linux'
              working-directory: frontend
              run: npm run electron:build:linux
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload Windows artifacts
              if: matrix.os == 'windows'
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact }}
                  path: |
                      frontend/dist-electron/*.exe
                  retention-days: 5

            - name: Upload macOS artifacts
              if: matrix.os == 'macos'
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact }}
                  path: |
                      frontend/dist-electron/*.dmg
                      frontend/dist-electron/*.zip
                  retention-days: 5

            - name: Upload Linux artifacts
              if: matrix.os == 'linux'
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact }}
                  path: |
                      frontend/dist-electron/*.AppImage
                      frontend/dist-electron/*.deb
                      frontend/dist-electron/*.rpm
                  retention-days: 5

    release:
        name: Create GitHub Release
        needs: build
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Read version
              id: version
              run: |
                  VERSION=$(jq -r '.version' config.json)
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Version: $VERSION"

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: release-artifacts

            - name: Display structure of downloaded files
              run: ls -R release-artifacts

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: v${{ steps.version.outputs.version }}
                  name: Minepanel v${{ steps.version.outputs.version }}
                  body: |
                      ## üéÆ Minepanel Desktop v${{ steps.version.outputs.version }}

                      ### üì¶ Downloads

                      #### Windows
                      - **Installer (NSIS)**: `Minepanel-${{ steps.version.outputs.version }}-x64-setup.exe` - Recommended for most users
                      - **Portable**: `Minepanel-${{ steps.version.outputs.version }}-x64.exe` - No installation required

                      #### macOS
                      - **Intel (x64)**: `Minepanel-${{ steps.version.outputs.version }}-x64.dmg`
                      - **Apple Silicon (arm64)**: `Minepanel-${{ steps.version.outputs.version }}-arm64.dmg`
                      - **Universal zip**: Available for both architectures

                      #### Linux
                      - **AppImage**: `Minepanel-${{ steps.version.outputs.version }}-x64.AppImage` - Works on most distributions
                      - **Debian/Ubuntu**: `Minepanel-${{ steps.version.outputs.version }}-x64.deb`
                      - **Red Hat/Fedora/CentOS**: `Minepanel-${{ steps.version.outputs.version }}-x64.rpm`

                      ### üöÄ Installation Instructions

                      #### Windows
                      1. Download the installer or portable version
                      2. Run the `.exe` file
                      3. Follow the installation wizard (installer only)

                      #### macOS
                      1. Download the appropriate `.dmg` for your Mac
                      2. Open the `.dmg` file
                      3. Drag Minepanel to Applications
                      4. If you see a security warning, go to System Preferences ‚Üí Security & Privacy ‚Üí Allow

                      #### Linux

                      **AppImage** (Recommended):
                      ```bash
                      chmod +x Minepanel-${{ steps.version.outputs.version }}-x64.AppImage
                      ./Minepanel-${{ steps.version.outputs.version }}-x64.AppImage
                      ```

                      **Debian/Ubuntu**:
                      ```bash
                      sudo dpkg -i Minepanel-${{ steps.version.outputs.version }}-x64.deb
                      ```

                      **Red Hat/Fedora/CentOS**:
                      ```bash
                      sudo rpm -i Minepanel-${{ steps.version.outputs.version }}-x64.rpm
                      ```

                      ### üìù What's New

                      - First stable release of Minepanel Desktop
                      - Multi-language support (English, Spanish, Dutch)
                      - Easy server connection management
                      - Native desktop experience

                      ### üê≥ Docker Images

                      Docker images are also available:
                      ```bash
                      docker pull ${{ secrets.DOCKERHUB_USERNAME }}/minepanel:${{ steps.version.outputs.version }}
                      docker pull ${{ secrets.DOCKERHUB_USERNAME }}/minepanel:latest
                      ```

                      ### üîó Links

                      - [Documentation](https://github.com/${{ github.repository }})
                      - [Report Issues](https://github.com/${{ github.repository }}/issues)
                      - [Source Code](https://github.com/${{ github.repository }})
                  draft: false
                  prerelease: false
                  files: |
                      release-artifacts/**/*
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Release created
              run: |
                  echo "‚úÖ Release v${{ steps.version.outputs.version }} created successfully!"
                  echo "üéâ Electron apps are now available for download"
                  echo "üì¶ Windows, macOS, and Linux builds included"
